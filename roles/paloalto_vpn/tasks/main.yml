---
- name: 1. Configurar IKE Crypto Profile (Phase 1)
  paloaltonetworks.panos.panos_ike_crypto_profile:
    provider: "{{ pa_provider }}"
    name: "S2S-FG-PA-IKE"
    dh_group: ["group14"]
    # Ajustado a lo que soporta tu FortiGate VM
    encryption: ["des-cbc"]
    hash: ["sha256"]
    lifetime_seconds: 43200
    state: "present"

- name: 2. Configurar IPsec Crypto Profile (Phase 2)
  paloaltonetworks.panos.panos_ipsec_crypto_profile:
    provider: "{{ pa_provider }}"
    name: "S2S-FG-PA-IPSEC"
    dh_group: "group14"
    esp_encryption: ["des-cbc"]
    esp_authentication: ["sha256"]
    # Cr√≠tico: Coincidir 1 hora con FortiGate
    lifetime_seconds: 3600
    state: "present"

- name: 3. Crear Interfaz de Tunel (tunnel.1)
  paloaltonetworks.panos.panos_interface:
    provider: "{{ pa_provider }}"
    if_name: "tunnel.1"
    ip: ["169.255.1.2/30"]
    create_default_route: false
    enable_dhcp: false
    # Asignar a Virtual Router y Zona
    vr_name: "default"
    zone_name: "VPN_Zone"
    state: "present"

- name: 4. Configurar IKE Gateway
  paloaltonetworks.panos.panos_ike_gateway:
    provider: "{{ pa_provider }}"
    name: "S2S-FG-PA-GW"
    version: "ikev2"
    interface: "ethernet1/1"   # Asumiendo esta es tu WAN en PA
    local_ip_address: "192.168.2.99"
    peer_ip_value: "192.168.1.99" # IP del FortiGate
    pre_shared_key: "{{ vpn_psk }}"
    crypto_profile: "S2S-FG-PA-IKE"
    liveness_check: 5
    state: "present"

- name: 5. Configurar IPSec Tunnel + Proxy IDs
  paloaltonetworks.panos.panos_ipsec_tunnel:
    provider: "{{ pa_provider }}"
    name: "S2S-FG-PA"
    tunnel_interface: "tunnel.1"
    ike_gw: "S2S-FG-PA-GW"
    ipsec_profile: "S2S-FG-PA-IPSEC"
    enable_tunneling: true
    state: "present"

- name: 5.1 Agregar Proxy ID Wildcard (Compatibilidad FortiGate)
  paloaltonetworks.panos.panos_ipsec_tunnel_proxy_id:
    provider: "{{ pa_provider }}"
    tunnel_name: "S2S-FG-PA"
    name: "Wildcard-S2S"
    local: "0.0.0.0/0"
    remote: "0.0.0.0/0"
    state: "present"

- name: 6. Configurar Ruta Estatica hacia Site A
  paloaltonetworks.panos.panos_static_route:
    provider: "{{ pa_provider }}"
    name: "Ruta-a-SiteA"
    destination: "10.100.100.0/22"
    nexthop_type: "ip-address"
    nexthop: "169.255.1.1"
    interface: "tunnel.1"
    virtual_router: "default"
    state: "present"

- name: 7. Commit (Aplicar Cambios)
  paloaltonetworks.panos.panos_commit:
    provider: "{{ pa_provider }}"
