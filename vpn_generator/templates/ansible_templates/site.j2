---
- name: Despliegue Automatizado VPN (Generado por Web UI)
  hosts: fortigates
  connection: httpapi
  gather_facts: no
  collections:
    - fortinet.fortios
  
  vars_files:
    - group_vars/all.yml

  tasks:
    # ----------------------------------------------------
    # TAREAS DE INTERFACES LAN (Variables Corregidas)
    # ----------------------------------------------------
    - name: Configurar LAN 1 ({{ fg_lan1_interface }})
      fortios_system_interface:
        vdom: "root"
        state: "present"
        system_interface:
          name: "{{ fg_lan1_interface }}"  # <--- CORREGIDO: Usa nombre directo del HTML
          vdom: "root"
          mode: "static"
          ip: "{{ fg_lan1_ip | replace('/', ' ') }}" # Truco para formato "IP Mask"
          allowaccess: "ping,https,ssh"
          alias: "LAN_1_Generada"

    - name: Configurar LAN 2 ({{ fg_lan2_interface }})
      fortios_system_interface:
        vdom: "root"
        state: "present"
        system_interface:
          name: "{{ fg_lan2_interface }}"  # <--- CORREGIDO
          vdom: "root"
          mode: "static"
          ip: "{{ fg_lan2_ip | replace('/', ' ') }}"
          allowaccess: "ping"
          alias: "LAN_2_Generada"

    # ----------------------------------------------------
    # TAREAS VPN
    # ----------------------------------------------------
    - name: Configurar VPN Phase 1
      fortios_vpn_ipsec_phase1_interface:
        vdom: "root"
        state: "present"
        vpn_ipsec_phase1_interface:
          name: "{{ vpn_name }}"
          interface: "{{ fg_wan_interface }}" # <--- CORREGIDO
          ike_version: "2"
          peertype: "any"
          net_device: "disable"
          proposal: "{{ phase1_prop }}"
          dhgrp: "{{ dh_group }}"
          remote_gw: "{{ fg_remote_gw }}" 
          psksecret: "{{ vpn_psk }}"
          nattraversal: "disable"

    - name: Configurar VPN Phase 2
      fortios_vpn_ipsec_phase2_interface:
        vdom: "root"
        state: "present"
        vpn_ipsec_phase2_interface:
          name: "{{ vpn_name }}-P2"
          phase1name: "{{ vpn_name }}"
          proposal: "{{ phase2_proposal }}"
          dhgrp: "{{ dh_group }}"
          keylifeseconds: 3600
          src_subnet: "0.0.0.0 0.0.0.0"
          dst_subnet: "0.0.0.0 0.0.0.0"
          auto_negotiate: "enable"

    - name: Politica Firewall Salida
      fortios_firewall_policy:
        vdom: "root"
        state: "present"
        firewall_policy:
          policyid: "100"
          name: "LAN-to-VPN"
          srcintf:
            - name: "{{ fg_lan1_interface }}"
            - name: "{{ fg_lan2_interface }}"
          dstintf:
            - name: "{{ vpn_name }}"
          srcaddr:
            - name: "all"
          dstaddr:
            - name: "all"
          action: "accept"
          schedule: "always"
          service:
            - name: "ALL"
          nat: "disable"
          logtraffic: "all"

    - name: Politica Firewall Entrada
      fortios_firewall_policy:
        vdom: "root"
        state: "present"
        firewall_policy:
          policyid: "101"
          name: "VPN-to-LAN"
          srcintf:
            - name: "{{ vpn_name }}"
          dstintf:
            - name: "{{ fg_lan1_interface }}"
            - name: "{{ fg_lan2_interface }}"
          srcaddr:
            - name: "all"
          dstaddr:
            - name: "all"
          action: "accept"
          schedule: "always"
          service:
            - name: "ALL"
          nat: "disable"
          logtraffic: "all"

- name: Despliegue Palo Alto (Stub)
  hosts: paloaltos
  connection: local
  gather_facts: no
  tasks:
    - debug:
        msg: "Configuracion lista para Palo Alto en {{ pa_wan_interface }} usando perfil {{ palo_enc }}/{{ palo_auth }}"