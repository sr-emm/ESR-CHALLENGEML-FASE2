---
# ==============================================================================
# PLAY 1: FORTIGATE - OVERLAY (VPN + ROUTING + POLICIES)
# ==============================================================================
- name: Configurar Overlay FortiGate
  hosts: fortigates
  connection: local
  gather_facts: no
  collections:
    - fortinet.fortios
  
  vars_files:
    - group_vars/all.yml

  tasks:
    # TAREA 0: Esperar API
    - name: Check API Availability
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: 443
        timeout: 10
      delegate_to: localhost
      ignore_errors: yes

    # 1. VPN (IPSec)
    - name: Configurar VPN Phase 1
      fortios_vpn_ipsec_phase1_interface:
        vdom: "root"
        state: "present"
        vpn_ipsec_phase1_interface:
          name: "{{ vpn_name }}"
          interface: "{{ fg_wan_intf }}" # Usa la interfaz existente, no la crea
          ike_version: "2"
          peertype: "any"
          net_device: "disable"
          proposal: "{{ phase1_proposal }}"
          dhgrp: "{{ dh_group }}"
          remote_gw: "{{ fg_remote_gw }}" 
          psksecret: "{{ vpn_psk }}"
          nattraversal: "disable"

    - name: Configurar VPN Phase 2
      fortios_vpn_ipsec_phase2_interface:
        vdom: "root"
        state: "present"
        vpn_ipsec_phase2_interface:
          name: "{{ vpn_name }}-P2"
          phase1name: "{{ vpn_name }}"
          proposal: "{{ phase2_proposal }}"
          dhgrp: "{{ dh_group }}"
          keylifeseconds: 3600
          src_subnet: "0.0.0.0 0.0.0.0"
          dst_subnet: "0.0.0.0 0.0.0.0"
          auto_negotiate: "enable"

    # 2. Interfaz de Túnel (Overlay)
    - name: Configurar Interfaz Túnel (VTI)
      fortios_system_interface:
        vdom: "root"
        state: "present"
        system_interface:
          name: "{{ vpn_name }}"
          vdom: "root"
          type: "tunnel"
          interface: "{{ fg_wan_intf }}"
          ip: "{{ fg_tunnel_ip }}"        # Variable calculada /32
          remote_ip: "{{ fg_remote_tunnel_ip }}"
          allowaccess: "ping"

    # 3. Routing (Rutas Estáticas hacia LANs remotas)
    - name: Ruta hacia Site B (LAN 1)
      fortios_router_static:
        vdom: "root"
        state: "present"
        router_static:
          seq_num: "10"
          dst: "{{ fg_route_dst1 }}"      # Variable formateada en Python
          device: "{{ vpn_name }}"

    - name: Ruta hacia Site B (LAN 2)
      fortios_router_static:
        vdom: "root"
        state: "present"
        router_static:
          seq_num: "11"
          dst: "{{ fg_route_dst2 }}"
          device: "{{ vpn_name }}"

    # 4. Políticas de Firewall
    - name: Politica Salida (LAN -> VPN)
      fortios_firewall_policy:
        vdom: "root"
        state: "present"
        firewall_policy:
          policyid: "100"
          name: "LAN-to-VPN"
          srcintf:
            - name: "{{ fg_lan1_intf }}"
            - name: "{{ fg_lan2_intf }}"
          dstintf:
            - name: "{{ vpn_name }}"
          srcaddr: [{name: "all"}]
          dstaddr: [{name: "all"}]
          action: "accept"
          schedule: "always"
          service: [{name: "ALL"}]
          nat: "disable"
          logtraffic: "all"

    - name: Politica Entrada (VPN -> LAN)
      fortios_firewall_policy:
        vdom: "root"
        state: "present"
        firewall_policy:
          policyid: "101"
          name: "VPN-to-LAN"
          srcintf:
            - name: "{{ vpn_name }}"
          dstintf:
            - name: "{{ fg_lan1_intf }}"
            - name: "{{ fg_lan2_intf }}"
          srcaddr: [{name: "all"}]
          dstaddr: [{name: "all"}]
          action: "accept"
          schedule: "always"
          service: [{name: "ALL"}]
          nat: "disable"
          logtraffic: "all"


# ==============================================================================
# PLAY 2: PALO ALTO - OVERLAY
# ==============================================================================
- name: Configurar Overlay Palo Alto
  hosts: paloaltos
  connection: local
  gather_facts: no
  collections:
    - paloaltonetworks.panos
  
  vars_files:
    - group_vars/all.yml

  tasks:
    # 1. Interfaz Túnel (Solo esta, no las físicas)
    - name: Configurar Interfaz Túnel
      panos_interface:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        if_name: "tunnel.1"
        mode: "layer3"
        ip: ["{{ pa_tunnel_ip }}"]
        vr_name: "default"
        zone_name: "VPN_Zone"

    # 2. Crypto Profiles
    - name: Perfil IKE
      panos_ike_crypto_profile:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        name: "{{ vpn_name }}-IKE"
        dh_group: ["group{{ dh_group }}"]
        encryption: ["{{ pa_enc_algo }}"]
        hash: ["{{ pa_auth_algo }}"]
        lifetime_seconds: 43200

    - name: Perfil IPsec
      panos_ipsec_profile:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        name: "{{ vpn_name }}-IPSEC"
        dh_group: "group{{ dh_group }}"
        esp_encryption: ["{{ pa_enc_algo }}"]
        esp_authentication: ["{{ pa_auth_algo }}"]
        lifetime_seconds: 3600

    # 3. VPN Objects
    - name: IKE Gateway
      panos_ike_gateway:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        name: "{{ vpn_name }}-GW"
        version: "ikev2"
        interface: "{{ pa_wan_intf }}"    # Usa la interfaz existente
        peer_ip: "{{ pa_peer_ip }}"
        pre_shared_key: "{{ vpn_psk }}"
        ikev2_crypto_profile: "{{ vpn_name }}-IKE"
        enable_liveness_check: true
        liveness_check_interval: 5

    - name: IPSec Tunnel
      panos_ipsec_tunnel:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        name: "{{ vpn_name }}"
        tunnel_interface: "tunnel.1"
        ike_gw: "{{ vpn_name }}-GW"
        ipsec_profile: "{{ vpn_name }}-IPSEC"
        enable_tunneling: true

    - name: Proxy ID
      panos_config_element:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        xpath: "/config/devices/entry[@name='localhost.localdomain']/network/tunnel/ipsec/entry[@name='{{ vpn_name }}']/auto-key/proxy-id"
        element: |
          <entry name="Wildcard-S2S">
            <local>0.0.0.0/0</local>
            <remote>0.0.0.0/0</remote>
          </entry>

    # 4. Routing (Hacia las LANs del Forti)
    - name: Ruta Estática LAN 1
      panos_static_route:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        name: "Ruta-a-FG-LAN1"
        destination: "{{ fg_lan1_cidr }}" 
        nexthop_type: "ip-address"
        nexthop: "{{ pa_nexthop_ip }}"
        interface: "tunnel.1"
        virtual_router: "default"

    - name: Ruta Estática LAN 2
      panos_static_route:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        name: "Ruta-a-FG-LAN2"
        destination: "{{ fg_lan2_cidr }}" 
        nexthop_type: "ip-address"
        nexthop: "{{ pa_nexthop_ip }}"
        interface: "tunnel.1"
        virtual_router: "default"

    # 5. Políticas
    - name: Policy Trust-VPN
      panos_security_rule:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        rule_name: "Permitir_Salida_VPN"
        source_zone: ["trust"]
        destination_zone: ["VPN_Zone"]
        action: "allow"

    - name: Policy VPN-Trust
      panos_security_rule:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        rule_name: "Permitir_Entrada_VPN"
        source_zone: ["VPN_Zone"]
        destination_zone: ["trust"]
        action: "allow"

    # 6. Commit
    - name: COMMIT
      panos_commit:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"