---
- name: Despliegue Automatizado VPN (Generado por Web UI)
  hosts: fortigates
  connection: httpapi
  gather_facts: no
  collections:
    - fortinet.fortios
  
  # Cargamos variables por si acaso, pero "quemaremos" los valores críticos aquí mismo
  vars_files:
    - group_vars/all.yml

  tasks:
    - name: Configurar VPN Phase 1 en FortiGate
      fortios_vpn_ipsec_phase1_interface:
        vdom: "root"
        state: "present"
        vpn_ipsec_phase1_interface:
          name: "{{ vpn_name }}"
          # CORRECCIÓN: Usar el nombre de variable del Formulario
          interface: "{{ fg_wan_interface }}"
          ike_version: "2"
          peertype: "any"
          net_device: "disable"
          # CORRECCIÓN: Usar el nombre de variable del Perfil Python
          proposal: "{{ phase1_prop }}"
          dhgrp: "{{ dh_group }}"
          remote_gw: "{{ fg_remote_gw }}"
          psksecret: "{{ vpn_psk }}"
          nattraversal: "disable"

    - name: Configurar VPN Phase 2
      fortios_vpn_ipsec_phase2_interface:
        vdom: "root"
        state: "present"
        vpn_ipsec_phase2_interface:
          name: "{{ vpn_name }}-P2"
          phase1name: "{{ vpn_name }}"
          # CORRECCIÓN: Usar el nombre de variable del Perfil Python
          proposal: "{{ phase2_prop }}"
          dhgrp: "{{ dh_group }}"
          keylifeseconds: 3600
          src_subnet: "0.0.0.0 0.0.0.0"
          dst_subnet: "0.0.0.0 0.0.0.0"
          auto_negotiate: "enable"

- name: Despliegue Palo Alto (Stub de Validación)
  hosts: paloaltos
  connection: local
  gather_facts: no
  tasks:
    - debug:
        # CORRECCIÓN: Variables de Palo Alto corregidas
        msg: "Configuracion lista para Palo Alto usando perfil {{ palo_enc }}/{{ palo_auth }}"