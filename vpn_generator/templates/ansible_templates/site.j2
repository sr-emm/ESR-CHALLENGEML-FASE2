---
- name: Despliegue Automatizado VPN (Generado por Web UI)
  hosts: fortigates
  connection: httpapi
  gather_facts: no
  collections:
    - fortinet.fortios
  
  vars_files:
    - group_vars/all.yml

  tasks:
    # ----------------------------------------------------
    # TAREAS DE INTERFACES LAN (Ahora Dinámicas)
    # ----------------------------------------------------
    - name: Configurar LAN 1 ({{ fg_lan1_intf }})
      fortios_system_interface:
        vdom: "root"
        state: "present"
        system_interface:
          name: "{{ fg_lan1_intf }}"  # Variable dinámica
          vdom: "root"
          mode: "static"
          ip: "{{ fg_lan1_cidr | replace('/', ' ') }}" # Truco para separar IP y Mask si es necesario, o pasar CIDR si la colección lo soporta. Forti prefiere "IP Mask".
          # NOTA: En producción idealmente separaríamos IP y Máscara en Python
          # Para este ejemplo asumimos que el usuario pone formato compatible o usamos 'allowaccess'
          allowaccess: "ping,https,ssh"
          alias: "LAN_1_Generada"

    - name: Configurar LAN 2 ({{ fg_lan2_intf }})
      fortios_system_interface:
        vdom: "root"
        state: "present"
        system_interface:
          name: "{{ fg_lan2_intf }}"
          vdom: "root"
          mode: "static"
          allowaccess: "ping"
          alias: "LAN_2_Generada"
          # Nota: La IP se configuraría igual que arriba

    # ----------------------------------------------------
    # TAREAS VPN (Ya corregidas)
    # ----------------------------------------------------
    - name: Configurar VPN Phase 1
      fortios_vpn_ipsec_phase1_interface:
        vdom: "root"
        state: "present"
        vpn_ipsec_phase1_interface:
          name: "{{ vpn_name }}"
          interface: "{{ fg_wan_intf }}"
          ike_version: "2"
          peertype: "any"
          net_device: "disable"
          proposal: "{{ phase1_proposal }}"
          dhgrp: "{{ dh_group }}"
          remote_gw: "{{ fg_remote_gw }}" 
          psksecret: "{{ vpn_psk }}"
          nattraversal: "disable"

    - name: Configurar VPN Phase 2
      fortios_vpn_ipsec_phase2_interface:
        vdom: "root"
        state: "present"
        vpn_ipsec_phase2_interface:
          name: "{{ vpn_name }}-P2"
          phase1name: "{{ vpn_name }}"
          proposal: "{{ phase2_proposal }}"
          dhgrp: "{{ dh_group }}"
          keylifeseconds: 3600
          src_subnet: "0.0.0.0 0.0.0.0"
          dst_subnet: "0.0.0.0 0.0.0.0"
          auto_negotiate: "enable"

    - name: Politica Firewall Salida
      fortios_firewall_policy:
        vdom: "root"
        state: "present"
        firewall_policy:
          policyid: "100"
          name: "LAN-to-VPN"
          srcintf:
            - name: "{{ fg_lan1_intf }}" # Dinámico
            - name: "{{ fg_lan2_intf }}" # Dinámico
          dstintf:
            - name: "{{ vpn_name }}"
          srcaddr:
            - name: "all"
          dstaddr:
            - name: "all"
          action: "accept"
          schedule: "always"
          service:
            - name: "ALL"
          nat: "disable"
          logtraffic: "all"

# ... (El resto del playbook de políticas de entrada sigue la misma lógica)