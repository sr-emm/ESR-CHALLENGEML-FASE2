---
# ==============================================================================
# PLAY 1: CONFIGURACIÓN FORTIGATE (SITE A)
# ==============================================================================
- name: Despliegue Automatizado FortiGate (Site A)
  hosts: fortigates
  connection: httpapi
  gather_facts: no
  collections:
    - fortinet.fortios
  
  vars_files:
    - group_vars/all.yml

  tasks:
    # --- 1. Interfaces LAN ---
    - name: Configurar LAN 1 ({{ fg_lan1_interface }})
      fortios_system_interface:
        vdom: "root"
        state: "present"
        system_interface:
          name: "{{ fg_lan1_interface }}"
          vdom: "root"
          mode: "static"
          ip: "{{ fg_lan1_fmt }}"
          allowaccess: "ping,https,ssh"
          alias: "LAN_1_Generada"

    - name: Configurar LAN 2 ({{ fg_lan2_interface }})
      fortios_system_interface:
        vdom: "root"
        state: "present"
        system_interface:
          name: "{{ fg_lan2_interface }}"
          vdom: "root"
          mode: "static"
          ip: "{{ fg_lan2_fmt }}"
          allowaccess: "ping"
          alias: "LAN_2_Generada"

    # --- 2. VPN (IPSec) ---
    - name: Configurar VPN Phase 1
      fortios_vpn_ipsec_phase1_interface:
        vdom: "root"
        state: "present"
        vpn_ipsec_phase1_interface:
          name: "{{ vpn_name }}"
          interface: "{{ fg_wan_interface }}"
          ike_version: "2"
          peertype: "any"
          net_device: "disable"
          proposal: "{{ phase1_prop }}"
          dhgrp: "{{ dh_group }}"
          remote_gw: "{{ fg_remote_gw }}" 
          psksecret: "{{ vpn_psk }}"
          nattraversal: "disable"

    - name: Configurar VPN Phase 2
      fortios_vpn_ipsec_phase2_interface:
        vdom: "root"
        state: "present"
        vpn_ipsec_phase2_interface:
          name: "{{ vpn_name }}-P2"
          phase1name: "{{ vpn_name }}"
          proposal: "{{ phase2_proposal }}"
          dhgrp: "{{ dh_group }}"
          keylifeseconds: 3600
          src_subnet: "0.0.0.0 0.0.0.0"
          dst_subnet: "0.0.0.0 0.0.0.0"
          auto_negotiate: "enable"

    # --- 3. Interfaz de Túnel ---
    - name: Configurar Interfaz Túnel (VTI)
      fortios_system_interface:
        vdom: "root"
        state: "present"
        system_interface:
          name: "{{ vpn_name }}"
          vdom: "root"
          ip: "{{ fg_tunnel_ip }}"
          allowaccess: "ping"
          type: "tunnel"
          interface: "{{ fg_wan_interface }}"
          remote_ip: "{{ fg_remote_tunnel_ip }}"

    # --- 4. Routing ---
    - name: Ruta Estática hacia Site B (LAN 1)
      fortios_router_static:
        vdom: "root"
        state: "present"
        router_static:
          seq_num: "10"
          dst: "{{ pa_lan1_fmt }}"
          device: "{{ vpn_name }}"

    - name: Ruta Estática hacia Site B (LAN 2)
      fortios_router_static:
        vdom: "root"
        state: "present"
        router_static:
          seq_num: "11"
          dst: "{{ pa_lan2_fmt }}"
          device: "{{ vpn_name }}"

    # --- 5. Políticas de Firewall ---
    - name: Politica Firewall (Salida)
      fortios_firewall_policy:
        vdom: "root"
        state: "present"
        firewall_policy:
          policyid: "100"
          name: "LAN-to-VPN"
          srcintf:
            - name: "{{ fg_lan1_interface }}"
            - name: "{{ fg_lan2_interface }}"
          dstintf:
            - name: "{{ vpn_name }}"
          srcaddr:
            - name: "all"
          dstaddr:
            - name: "all"
          action: "accept"
          schedule: "always"
          service:
            - name: "ALL"
          nat: "disable"
          logtraffic: "all"

    - name: Politica Firewall (Entrada)
      fortios_firewall_policy:
        vdom: "root"
        state: "present"
        firewall_policy:
          policyid: "101"
          name: "VPN-to-LAN"
          srcintf:
            - name: "{{ vpn_name }}"
          dstintf:
            - name: "{{ fg_lan1_interface }}"
            - name: "{{ fg_lan2_interface }}"
          srcaddr:
            - name: "all"
          dstaddr:
            - name: "all"
          action: "accept"
          schedule: "always"
          service:
            - name: "ALL"
          nat: "disable"
          logtraffic: "all"


# ==============================================================================
# PLAY 2: CONFIGURACIÓN PALO ALTO (SITE B)
# ==============================================================================
- name: Despliegue Automatizado Palo Alto (Site B)
  hosts: paloaltos
  connection: local
  gather_facts: no
  collections:
    - paloaltonetworks.panos
  
  vars_files:
    - group_vars/all.yml

  tasks:
    # --- 1. Interfaces ---
    - name: Configurar WAN ({{ pa_wan_intf }})
      paloaltonetworks.panos.panos_interface:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        if_name: "{{ pa_wan_intf }}"
        mode: "layer3"
        enable_dhcp: "{{ 'true' if pa_is_dhcp else 'false' }}"
        create_default_route: "{{ 'true' if pa_is_dhcp else 'false' }}"
        ip: "{{ [pa_wan_ip] if not pa_is_dhcp else omit }}"
        vr_name: "default"
        zone_name: "untrust"

    - name: Configurar LAN 1 ({{ pa_lan1_intf }})
      paloaltonetworks.panos.panos_interface:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        if_name: "{{ pa_lan1_intf }}"
        mode: "layer3"
        ip: ["{{ pa_lan1_cidr }}"]
        vr_name: "default"
        zone_name: "trust"

    - name: Configurar LAN 2 ({{ pa_lan2_intf }})
      paloaltonetworks.panos.panos_interface:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        if_name: "{{ pa_lan2_intf }}"
        mode: "layer3"
        ip: ["{{ pa_lan2_cidr }}"]
        vr_name: "default"
        zone_name: "trust"

    - name: Configurar Interfaz Túnel (tunnel.1)
      paloaltonetworks.panos.panos_interface:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        if_name: "tunnel.1"
        mode: "layer3"
        ip: ["{{ pa_tunnel_ip }}"]
        vr_name: "default"
        zone_name: "VPN_Zone"

    # --- 2. Perfiles Criptográficos ---
    - name: Perfil IKE (Phase 1)
      paloaltonetworks.panos.panos_ike_crypto_profile:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        name: "{{ vpn_name }}-IKE"
        dh_group: ["group{{ dh_group }}"]
        encryption: ["{{ pa_enc_algo }}"]
        hash: ["{{ pa_auth_algo }}"]
        lifetime_seconds: 43200

    - name: Perfil IPsec (Phase 2)
      paloaltonetworks.panos.panos_ipsec_profile:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        name: "{{ vpn_name }}-IPSEC"
        dh_group: "group{{ dh_group }}"
        esp_encryption: ["{{ pa_enc_algo }}"]
        esp_authentication: ["{{ pa_auth_algo }}"]
        lifetime_seconds: 3600

    # --- 3. VPN ---
    - name: Configurar IKE Gateway
      paloaltonetworks.panos.panos_ike_gateway:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        name: "{{ vpn_name }}-GW"
        version: "ikev2"
        interface: "{{ pa_wan_intf }}"
        peer_ip: "{{ pa_peer_ip }}"
        pre_shared_key: "{{ vpn_psk }}"
        ikev2_crypto_profile: "{{ vpn_name }}-IKE"
        enable_liveness_check: true
        liveness_check_interval: 5

    - name: Configurar IPSec Tunnel
      paloaltonetworks.panos.panos_ipsec_tunnel:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        name: "{{ vpn_name }}"
        tunnel_interface: "tunnel.1"
        ike_gw: "{{ vpn_name }}-GW"
        ipsec_profile: "{{ vpn_name }}-IPSEC"
        enable_tunneling: true

    - name: Agregar Proxy ID Wildcard (Compatibilidad Universal)
      paloaltonetworks.panos.panos_config_element:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        xpath: "/config/devices/entry[@name='localhost.localdomain']/network/tunnel/ipsec/entry[@name='{{ vpn_name }}']/auto-key/proxy-id"
        element: |
          <entry name="Wildcard-S2S">
            <local>0.0.0.0/0</local>
            <remote>0.0.0.0/0</remote>
          </entry>

    # --- 4. Routing ---
    - name: Ruta Estática hacia LAN 1 FG
      paloaltonetworks.panos.panos_static_route:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        name: "Ruta-a-SiteA-LAN1"
        destination: "{{ fg_lan1_cidr }}" 
        nexthop_type: "ip-address"
        nexthop: "{{ fg_tunnel_ip.split(' ')[0] }}"
        interface: "tunnel.1"
        virtual_router: "default"

    - name: Ruta Estática hacia LAN 2 FG
      paloaltonetworks.panos.panos_static_route:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        name: "Ruta-a-SiteA-LAN2"
        destination: "{{ fg_lan2_cidr }}" 
        nexthop_type: "ip-address"
        nexthop: "{{ fg_tunnel_ip.split(' ')[0] }}"
        interface: "tunnel.1"
        virtual_router: "default"

    # --- 5. Políticas de Seguridad ---
    - name: Política de Seguridad (Salida VPN)
      paloaltonetworks.panos.panos_security_rule:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        rule_name: "Permitir_VPN_Salida"
        source_zone: ["trust"]
        destination_zone: ["VPN_Zone"]
        source_ip: ["any"]
        destination_ip: ["any"]
        application: ["any"]
        service: ["application-default"]
        action: "allow"

    - name: Política de Seguridad (Entrada VPN)
      paloaltonetworks.panos.panos_security_rule:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"
        rule_name: "Permitir_VPN_Entrada"
        source_zone: ["VPN_Zone"]
        destination_zone: ["trust"]
        source_ip: ["any"]
        destination_ip: ["any"]
        application: ["any"]
        service: ["application-default"]
        action: "allow"

    # --- 6. Commit ---
    - name: COMMIT FINAL (Palo Alto)
      paloaltonetworks.panos.panos_commit:
        provider: "{{ '{{' }} pa_provider {{ '}}' }}"