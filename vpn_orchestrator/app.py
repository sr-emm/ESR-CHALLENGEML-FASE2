import osimport ioimport zipfileimport base64from flask import Flask, request, send_file, render_template_string, jsonifyapp = Flask(__name__)# --- LÓGICA DE GENERACIÓN DE ANSIBLE (BACKEND) ---def cidr_to_ip_mask(cidr):    if not cidr: return "0.0.0.0 0.0.0.0"    try:        if '/' not in cidr: return f"{cidr} 255.255.255.255"        ip_addr, mask_len = cidr.split('/')        mask_len = int(mask_len)        mask = (0xffffffff << (32 - mask_len)) & 0xffffffff        mask_str = ".".join(str((mask >> i) & 0xff) for i in [24, 16, 8, 0])        return f"{ip_addr} {mask_str}"    except: return f"{cidr}"def get_pa_crypto_config(profile):    config = {        "DES-SHA256": {"encryption": ["des"], "hash": ["sha256"], "esp_encryption": ["des"], "esp_authentication": ["sha256"]},        "AES128-SHA256": {"encryption": ["aes-128-cbc"], "hash": ["sha256"], "esp_encryption": ["aes-128-cbc"], "esp_authentication": ["sha256"]},        "AES256-SHA256": {"encryption": ["aes-256-cbc"], "hash": ["sha256"], "esp_encryption": ["aes-256-cbc"], "esp_authentication": ["sha256"]},    }    return config.get(profile, config["AES128-SHA256"])def get_fg_crypto_proposal(profile):    config = {        "DES-SHA256": "des-sha256",        "AES128-SHA256": "aes128-sha256",        "AES256-SHA256": "aes256-sha256",    }    return config.get(profile, config["AES128-SHA256"])def generate_hosts_yml(data):    return f"""all:  children:    fortigates:      hosts:        forti_site_a:          ansible_host: {data['fg_mgmt_ip']}          ansible_user: "{data['fg_user']}"          ansible_password: "{data['fg_password']}"          ansible_connection: local          ansible_network_os: fortinet.fortios.fortios          ansible_httpapi_use_ssl: yes          ansible_httpapi_validate_certs: no          ansible_httpapi_port: 443    paloaltos:      hosts:        palo_site_b:          ansible_host: {data['pa_mgmt_ip']}          ansible_user: "{data['pa_user']}"          ansible_password: "{data['pa_password']}"          ansible_connection: local"""def generate_group_vars_all_yml(data, pa_crypto):    fg_lan1_ip_mask = cidr_to_ip_mask(data['fg_lan1_cidr'])    fg_lan2_ip_mask = cidr_to_ip_mask(data['fg_lan2_cidr'])        # Mapeo cruzado de IPs remotas    fg_remote_gw = data.get('pa_remote_wan_ip', '10.100.100.115')    fg_remote_tunnel_ip = data.get('pa_remote_tunnel_ip', '169.255.1.2')    pa_peer_ip = data.get('fg_remote_wan_ip', '10.100.100.151')    pa_nexthop_ip = data.get('fg_remote_tunnel_ip_pa', '169.255.1.1')    # Limpieza de PSK    psk = data['psk'].replace("'", "").replace('"', "")    return f"""# --- GLOBAL ---vpn_name: "{data['tunnel_name']}"vpn_psk: "{psk}" # --- CRYPTO ---phase1_proposal: "{get_fg_crypto_proposal(data['crypto_profile'])}"phase2_proposal: "{get_fg_crypto_proposal(data['crypto_profile'])}"dh_group: "{data['dh_group']}"pa_enc_algo: "{pa_crypto['esp_encryption'][0]}"pa_auth_algo: "{pa_crypto['esp_authentication'][0]}"# --- FORTIGATE SITE A ---fg_wan_intf: "{data['fg_wan_intf']}"fg_lan1_intf: "{data['fg_lan1_intf']}"fg_lan2_intf: "{data['fg_lan2_intf']}"fg_wan_ip: "{data['fg_wan_ip']}" fg_vdom: "{data.get('fg_vdom_name', 'root')}"fg_lan1_cidr: "{fg_lan1_ip_mask}" fg_lan2_cidr: "{fg_lan2_ip_mask}"fg_remote_lan1_cidr: "{data['pa_lan1_cidr']}" fg_remote_lan2_cidr: "{data['pa_lan2_cidr']}"fg_tunnel_ip: "{data['fg_tunnel_ip']} 255.255.255.255"fg_remote_tunnel_ip: "{fg_remote_tunnel_ip} 255.255.255.255"fg_remote_gw: "{fg_remote_gw}" # --- PALO ALTO SITE B ---pa_wan_intf: "{data['pa_wan_intf']}"pa_lan1_intf: "{data['pa_lan1_intf']}"pa_lan2_intf: "{data['pa_lan2_intf']}"pa_zone: "{data.get('pa_zone_name', 'VPN_Zone')}"pa_lan1_cidr: "{data['pa_lan1_cidr']}"pa_lan2_cidr: "{data['pa_lan2_cidr']}"pa_remote_lan1_cidr: "{data['fg_lan1_cidr']}" pa_remote_lan2_cidr: "{data['fg_lan2_cidr']}"pa_wan_ip: "{data['pa_wan_ip']}"pa_tunnel_ip: "{data['pa_tunnel_ip']}/32"pa_peer_ip: "{pa_peer_ip}" pa_nexthop_ip: "{pa_nexthop_ip}"pa_provider:  ip_address: "{data['pa_mgmt_ip']}"  username: "{data['pa_user']}"  password: "{data['pa_password']}""""def generate_site_yml(data):    return f"""---# ==============================================================================# BEST PRACTICES BASED ON FORTINET TECH TIP 281924 (Route-Based VPN)# ==============================================================================# 1. Route-Based (VTI) - Static Routing (NO Policy-Based VPN)# 2. Phase 2 Selectors: 0.0.0.0/0 (Universal)# 3. Policies: Action ACCEPT, NAT DISABLE# ==============================================================================- name: Configurar Overlay FortiGate  hosts: fortigates  connection: local  gather_facts: no  collections:    - fortinet.fortios  vars_files:    - group_vars/all.yml  tasks:    - name: Check API Availability      ansible.builtin.wait_for:        host: "{{{{ fg_wan_ip }}}}"        port: 443        timeout: 5      delegate_to: localhost      ignore_errors: yes    # 1. VPN PHASE 1 (Interface Mode)    - name: Configurar VPN Phase 1 (IKE Gateway)      fortios_vpn_ipsec_phase1_interface:        vdom: "{{{{ fg_vdom }}}}"        state: "present"        vpn_ipsec_phase1_interface:          name: "{{{{ vpn_name }}}}"          interface: "{{{{ fg_wan_intf }}}}"           ike_version: "2"          peertype: "any"          net_device: "disable"          proposal: "{{{{ phase1_proposal }}}}"          dhgrp: "{{{{ dh_group }}}}"          remote_gw: "{{{{ fg_remote_gw }}}}"           psksecret: "{{{{ vpn_psk }}}}"          nattraversal: "disable"    # 2. VPN PHASE 2 (Selectors 0.0.0.0/0 for Route-Based)    - name: Configurar VPN Phase 2 (IPsec SA)      fortios_vpn_ipsec_phase2_interface:        vdom: "{{{{ fg_vdom }}}}"        state: "present"        vpn_ipsec_phase2_interface:          name: "{{{{ vpn_name }}}}-P2"          phase1name: "{{{{ vpn_name }}}}"          proposal: "{{{{ phase2_proposal }}}}"          dhgrp: "{{{{ dh_group }}}}"          keylifeseconds: 3600          src_subnet: "0.0.0.0 0.0.0.0"           dst_subnet: "0.0.0.0 0.0.0.0"          auto_negotiate: "enable"    # 3. INTERFACE (VTI)    - name: Configurar Interfaz Túnel (VTI)      fortios_system_interface:        vdom: "{{{{ fg_vdom }}}}"        state: "present"        system_interface:          name: "{{{{ vpn_name }}}}"          vdom: "{{{{ fg_vdom }}}}"          type: "tunnel"          interface: "{{{{ vpn_name }}}}"           ip: "{{{{ fg_tunnel_ip }}}}"                  remote_ip: "{{{{ fg_remote_tunnel_ip }}}}"          allowaccess: "ping"    # 4. ADDRESS OBJECTS    - name: Crear Objeto de Dirección para LAN Remota 1      fortios_firewall_address:        vdom: "{{{{ fg_vdom }}}}"        state: "present"        firewall_address:            name: "PA_LAN1_{{{{ fg_remote_lan1_cidr | regex_replace('/', '_') }}}}"            subnet: "{{{{ fg_remote_lan1_cidr | replace('/', ' ') }}}}"     - name: Crear Objeto de Dirección para LAN Remota 2      fortios_firewall_address:        vdom: "{{{{ fg_vdom }}}}"        state: "present"        firewall_address:            name: "PA_LAN2_{{{{ fg_remote_lan2_cidr | regex_replace('/', '_') }}}}"            subnet: "{{{{ fg_remote_lan2_cidr | replace('/', ' ') }}}}"     # 5. STATIC ROUTING (Route-Based VPN requirement)    - name: Ruta hacia Site B (LAN 1)      fortios_router_static:        vdom: "{{{{ fg_vdom }}}}"        state: "present"        router_static:          seq_num: "10"          dst: "{{{{ fg_remote_lan1_cidr | replace('/', ' ') }}}}"                device: "{{{{ vpn_name }}}}"    - name: Ruta hacia Site B (LAN 2)      fortios_router_static:        vdom: "{{{{ fg_vdom }}}}"        state: "present"        router_static:          seq_num: "11"          dst: "{{{{ fg_remote_lan2_cidr | replace('/', ' ') }}}}"          device: "{{{{ vpn_name }}}}"    # 6. FIREWALL POLICIES (No NAT)    - name: Politica Salida (LAN -> VPN)      fortios_firewall_policy:        vdom: "{{{{ fg_vdom }}}}"        state: "present"        firewall_policy:          policyid: "100"          name: "LAN-to-VPN"          srcintf:            - name: "{{{{ fg_lan1_intf }}}}"            - name: "{{{{ fg_lan2_intf }}}}"          dstintf:            - name: "{{{{ vpn_name }}}}"          srcaddr: [{name: "all"}]          dstaddr: [{name: "PA_LAN1_{{{{ fg_remote_lan1_cidr | regex_replace('/', '_') }}}}"}, {name: "PA_LAN2_{{{{ fg_remote_lan2_cidr | regex_replace('/', '_') }}}}"}]          action: "accept"          schedule: "always"          service: [{name: "ALL"}]          nat: "disable" # CRITICAL: NO NAT          logtraffic: "all"    - name: Politica Entrada (VPN -> LAN)      fortios_firewall_policy:        vdom: "{{{{ fg_vdom }}}}"        state: "present"        firewall_policy:          policyid: "101"          name: "VPN-to-LAN"          srcintf:            - name: "{{{{ vpn_name }}}}"          dstintf:            - name: "{{{{ fg_lan1_intf }}}}"            - name: "{{{{ fg_lan2_intf }}}}"          srcaddr: [{name: "PA_LAN1_{{{{ fg_remote_lan1_cidr | regex_replace('/', '_') }}}}"}, {name: "PA_LAN2_{{{{ fg_remote_lan2_cidr | regex_replace('/', '_') }}}}"}]          dstaddr: [{name: "all"}]          action: "accept"          schedule: "always"          service: [{name: "ALL"}]          nat: "disable" # CRITICAL: NO NAT          logtraffic: "all"- name: Configurar Overlay Palo Alto (Route-Based)  hosts: paloaltos  connection: local  gather_facts: no  collections:    - paloaltonetworks.panos  vars_files:    - group_vars/all.yml  tasks:    - name: Configurar Interfaz Túnel      panos_interface:        provider: "{{{{ pa_provider }}}}"        if_name: "tunnel.1"         mode: "layer3"        ip: ["{{{{ pa_tunnel_ip }}}}"]        vr_name: "default"        zone_name: "{{{{ pa_zone }}}}"        commit: False    - name: Perfil IKE      panos_ike_crypto_profile:        provider: "{{{{ pa_provider }}}}"        name: "{{{{ vpn_name }}}}-IKE"        dh_group: ["group{{{{ dh_group }}}}"]        encryption: ["{{{{ pa_enc_algo }}}}"]        hash: ["{{{{ pa_auth_algo }}}}"]        lifetime_seconds: 43200        commit: False    - name: Perfil IPsec      panos_ipsec_profile:        provider: "{{{{ pa_provider }}}}"        name: "{{{{ vpn_name }}}}-IPSEC"        dh_group: "group{{{{ dh_group }}}}"        esp_encryption: ["{{{{ pa_enc_algo }}}}"]        esp_authentication: ["{{{{ pa_auth_algo }}}}"]        lifetime_seconds: 3600        commit: False    - name: IKE Gateway      panos_ike_gateway:        provider: "{{{{ pa_provider }}}}"        name: "{{{{ vpn_name }}}}-GW"        version: "ikev2"        interface: "{{{{ pa_wan_intf }}}}"            peer_ip: "{{{{ pa_peer_ip }}}}"        pre_shared_key: "{{{{ vpn_psk }}}}"        ikev2_crypto_profile: "{{{{ vpn_name }}}}-IKE"        enable_liveness_check: true        liveness_check_interval: 5        commit: False    - name: IPSec Tunnel      panos_ipsec_tunnel:        provider: "{{{{ pa_provider }}}}"        name: "{{{{ vpn_name }}}}"        tunnel_interface: "tunnel.1"        ike_gw: "{{{{ vpn_name }}}}-GW"        ipsec_profile: "{{{{ vpn_name }}}}-IPSEC"        enable_tunneling: true        commit: False    - name: Proxy ID (0.0.0.0/0 for Route-Based Compatibility)      panos_config_element:        provider: "{{{{ pa_provider }}}}"        xpath: "/config/devices/entry[@name='localhost.localdomain']/network/tunnel/ipsec/entry[@name='{{{{ vpn_name }}}}']/auto-key/proxy-id"        element: |          <entry name="Wildcard-S2S">            <local>0.0.0.0/0</local>            <remote>0.0.0.0/0</remote>          </entry>        commit: False    - name: Ruta Estática LAN 1 (a FG)      panos_static_route:        provider: "{{{{ pa_provider }}}}"        name: "Ruta-a-FG-LAN1"        destination: "{{{{ pa_remote_lan1_cidr }}}}"         nexthop_type: "ip-address"        nexthop: "{{{{ pa_nexthop_ip }}}}"        interface: "tunnel.1"        virtual_router: "default"        commit: False    - name: Ruta Estática LAN 2 (a FG)      panos_static_route:        provider: "{{{{ pa_provider }}}}"        name: "Ruta-a-FG-LAN2"        destination: "{{{{ pa_remote_lan2_cidr }}}}"         nexthop_type: "ip-address"        nexthop: "{{{{ pa_nexthop_ip }}}}"        interface: "tunnel.1"        virtual_router: "default"        commit: False            - name: Crear Zona VPN si no existe      panos_zone:        provider: "{{{{ pa_provider }}}}"        zone: "{{{{ pa_zone }}}}"        mode: layer3        interface: ['tunnel.1']        commit: False    - name: Policy Trust-VPN (Salida)      panos_security_rule:        provider: "{{{{ pa_provider }}}}"        rule_name: "Permitir_Salida_{{{{ vpn_name }}}}"        source_zone: ["trust"]        destination_zone: ["{{{{ pa_zone }}}}"]        source_ip: ["any"]        destination_ip: ["{{{{ pa_remote_lan1_cidr }}}}", "{{{{ pa_remote_lan2_cidr }}}}"]        action: "allow"        commit: False    - name: Policy VPN-Trust (Entrada)      panos_security_rule:        provider: "{{{{ pa_provider }}}}"        rule_name: "Permitir_Entrada_{{{{ vpn_name }}}}"        source_zone: ["{{{{ pa_zone }}}}"]        destination_zone: ["trust"]        source_ip: ["{{{{ pa_remote_lan1_cidr }}}}", "{{{{ pa_remote_lan2_cidr }}}}"]        destination_ip: ["any"]        action: "allow"        commit: False    - name: COMMIT      panos_commit:        provider: "{{{{ pa_provider }}}}""""# --- PLANTILLA HTML (FRONTEND) ---# Se define como string para mantener el Single-File deployment, pero se sirve desde FlaskHTML_TEMPLATE = """<!DOCTYPE html><html lang="es" class="dark"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Generador VPN: FortiGate vs Palo Alto</title>    <script src="https://cdn.tailwindcss.com"></script>    <script>        tailwind.config = {            darkMode: 'class',            theme: {                extend: {                    colors: {                        gray: { 850: '#1f2937', 900: '#111827', 950: '#030712' },                        forti: { DEFAULT: '#C53030', dim: '#7F1D1D' },                        palo: { DEFAULT: '#0284c7', dim: '#0c4a6e' }                    }                }            }        }    </script>    <style>        body { font-family: 'Courier New', Courier, monospace; }        ::-webkit-scrollbar { width: 8px; }        ::-webkit-scrollbar-track { background: #1f2937; }        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }        .input-dark {            background-color: #374151; border: 1px solid #4b5563; color: #f3f4f6;            height: 2.5rem; display: flex; align-items: center;        }        .input-dark:focus { border-color: #60a5fa; ring: 2px solid #60a5fa; outline: none; }        select.input-dark { padding-top: 0.25rem; padding-bottom: 0.25rem; }        option:disabled { color: #9ca3af; font-style: italic; background-color: #374151; }        .label-fixed { display: flex; align-items: center; height: 100%; }    </style></head><body class="bg-gray-950 text-gray-100 min-h-screen p-4 md:p-8">    <div class="max-w-7xl mx-auto space-y-8">        <div class="text-center space-y-2">            <h1 class="text-4xl font-bold tracking-tight bg-gradient-to-r from-red-500 via-gray-200 to-sky-500 bg-clip-text text-transparent">                VPN Orchestrator            </h1>            <p class="text-gray-400 text-sm">FortiGate <-> Palo Alto Networks // Route-Based VPN (No NAT)</p>        </div>        <form id="vpnForm" class="space-y-6">            <!-- 1. GLOBAL SETTINGS -->            <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 shadow-xl">                <h2 class="text-xl font-bold text-gray-200 mb-4 flex items-center gap-2 border-b border-gray-800 pb-2">                    <span class="w-2 h-6 bg-purple-500 rounded-full"></span>                    Configuración Global del Túnel                </h2>                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">                    <div class="space-y-1">                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Nombre del Túnel</label>                        <input type="text" name="tunnel_name" value="S2S-OVERLAY" class="w-full rounded-md px-3 input-dark transition-all focus:ring-1 focus:ring-purple-500" required>                    </div>                    <div class="space-y-1">                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Pre-Shared Key</label>                        <input type="text" name="psk" value="FortinetVPN2025a1!" class="w-full rounded-md px-3 input-dark text-sm focus:ring-1 focus:ring-purple-500" required>                    </div>                    <div class="space-y-1">                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Diffie-Hellman</label>                        <select name="dh_group" class="w-full rounded-md px-3 input-dark focus:ring-1 focus:ring-purple-500">                            <option value="5">Group 5 (Legacy)</option>                            <option value="14" selected>Group 14 (Standard)</option>                            <option value="19">Group 19 (PFS - High)</option>                            <option value="21">Group 21 (PFS - Ultra)</option>                        </select>                    </div>                    <div class="space-y-1">                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Perfil Cifrado</label>                        <select name="crypto_profile" class="w-full rounded-md px-3 input-dark focus:ring-1 focus:ring-purple-500">                            <option value="DES-SHA256" class="text-yellow-400">1. LAB (DES-SHA256)</option>                            <option value="AES128-SHA256" selected class="text-green-400">2. Producción (AES128-SHA256)</option>                            <option value="AES256-SHA256" class="text-emerald-400">3. Seguridad (AES256-SHA256)</option>                        </select>                    </div>                </div>            </div>            <!-- 2. SIDE-BY-SIDE CONFIG -->            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">                <!-- FORTIGATE -->                <div class="bg-gray-900 border border-red-900/30 rounded-xl overflow-hidden shadow-lg relative">                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-red-700 to-red-500"></div>                    <div class="p-6 space-y-6">                        <div class="flex items-center justify-between border-b border-gray-800 pb-4">                            <h2 class="text-lg font-bold text-red-400 flex items-center gap-2">Site A: FortiGate</h2>                            <span class="text-xs text-gray-500 bg-gray-800 px-2 py-1 rounded border border-gray-700">root VDOM</span>                        </div>                        <div class="grid grid-cols-2 gap-4">                            <div><label class="text-xs text-gray-500 block mb-1">MGMT IP</label><input type="text" name="fg_mgmt_ip" value="10.100.100.151" class="w-full input-dark rounded px-3 text-sm border-l-4 border-l-red-600"></div>                            <div><label class="text-xs text-gray-500 block mb-1">WAN IP (Public)</label><input type="text" name="fg_wan_ip" value="10.100.100.151" class="w-full input-dark rounded px-3 text-sm"></div>                        </div>                        <div class="grid grid-cols-2 gap-4">                            <div><label class="text-xs text-gray-500 block mb-1">User</label><input type="text" name="fg_user" value="admin" class="w-full input-dark rounded px-3 text-sm"></div>                            <div><label class="text-xs text-gray-500 block mb-1">Password</label><input type="password" name="fg_password" value="1234wasd" class="w-full input-dark rounded px-3 text-sm"></div>                        </div>                        <hr class="border-gray-800">                        <div class="space-y-4">                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Configuración Interfaces</h3>                            <div class="grid grid-cols-12 gap-4 items-center">                                <label class="col-span-3 text-sm text-gray-300 label-fixed">WAN Intf</label>                                <div class="col-span-9"><select name="fg_wan_intf" id="fg_wan_intf" class="w-full input-dark rounded px-3 text-sm focus:border-red-500"></select></div>                            </div>                            <div class="grid grid-cols-12 gap-4 items-center">                                <label class="col-span-3 text-sm text-gray-300 label-fixed">LAN 1</label>                                <div class="col-span-4"><select name="fg_lan1_intf" id="fg_lan1_intf" class="w-full input-dark rounded px-3 text-sm focus:border-red-500"></select></div>                                <div class="col-span-5"><input type="text" name="fg_lan1_cidr" value="10.10.10.0/24" class="w-full input-dark rounded px-3 text-sm" placeholder="CIDR"></div>                            </div>                            <div class="grid grid-cols-12 gap-4 items-center">                                <label class="col-span-3 text-sm text-gray-300 label-fixed">LAN 2</label>                                <div class="col-span-4"><select name="fg_lan2_intf" id="fg_lan2_intf" class="w-full input-dark rounded px-3 text-sm focus:border-red-500"></select></div>                                <div class="col-span-5"><input type="text" name="fg_lan2_cidr" value="10.10.20.0/24" class="w-full input-dark rounded px-3 text-sm" placeholder="CIDR"></div>                            </div>                        </div>                        <div class="bg-red-900/10 p-4 rounded border border-red-900/30 mt-4">                            <label class="text-xs text-red-300 block mb-2 uppercase font-bold">Tunnel VTI IP</label>                            <input type="text" id="fg_tunnel_ip" name="fg_tunnel_ip" value="169.255.1.1" class="w-full bg-gray-800 border border-gray-700 text-white rounded px-3 h-10 text-sm focus:ring-red-500">                        </div>                    </div>                </div>                <!-- PALO ALTO -->                <div class="bg-gray-900 border border-sky-900/30 rounded-xl overflow-hidden shadow-lg relative">                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-sky-600 to-sky-400"></div>                    <div class="p-6 space-y-6">                        <div class="flex items-center justify-between border-b border-gray-800 pb-4">                            <h2 class="text-lg font-bold text-sky-400 flex items-center gap-2">Site B: Palo Alto</h2>                            <span class="text-xs text-gray-500 bg-gray-800 px-2 py-1 rounded border border-gray-700">Zone: VPN_Zone</span>                        </div>                        <div class="grid grid-cols-2 gap-4">                            <div><label class="text-xs text-gray-500 block mb-1">MGMT IP</label><input type="text" name="pa_mgmt_ip" value="10.100.100.115" class="w-full input-dark rounded px-3 text-sm border-l-4 border-l-sky-600"></div>                            <div><label class="text-xs text-gray-500 block mb-1">WAN IP (Public)</label><input type="text" name="pa_wan_ip" value="10.100.100.115" class="w-full input-dark rounded px-3 text-sm"></div>                        </div>                        <div class="grid grid-cols-2 gap-4">                            <div><label class="text-xs text-gray-500 block mb-1">User</label><input type="text" name="pa_user" value="admin" class="w-full input-dark rounded px-3 text-sm"></div>                            <div><label class="text-xs text-gray-500 block mb-1">Password</label><input type="password" name="pa_password" value="1234wasd" class="w-full input-dark rounded px-3 text-sm"></div>                        </div>                        <hr class="border-gray-800">                        <div class="space-y-4">                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Configuración Interfaces</h3>                            <div class="grid grid-cols-12 gap-4 items-center">                                <label class="col-span-3 text-sm text-gray-300 label-fixed">WAN Intf</label>                                <div class="col-span-9"><select name="pa_wan_intf" id="pa_wan_intf" class="w-full input-dark rounded px-3 text-sm focus:border-sky-500"></select></div>                            </div>                            <div class="grid grid-cols-12 gap-4 items-center">                                <label class="col-span-3 text-sm text-gray-300 label-fixed">LAN 1</label>                                <div class="col-span-4"><select name="pa_lan1_intf" id="pa_lan1_intf" class="w-full input-dark rounded px-3 text-sm focus:border-sky-500"></select></div>                                <div class="col-span-5"><input type="text" name="pa_lan1_cidr" value="172.16.10.0/24" class="w-full input-dark rounded px-3 text-sm" placeholder="CIDR"></div>                            </div>                            <div class="grid grid-cols-12 gap-4 items-center">                                <label class="col-span-3 text-sm text-gray-300 label-fixed">LAN 2</label>                                <div class="col-span-4"><select name="pa_lan2_intf" id="pa_lan2_intf" class="w-full input-dark rounded px-3 text-sm focus:border-sky-500"></select></div>                                <div class="col-span-5"><input type="text" name="pa_lan2_cidr" value="172.16.20.0/24" class="w-full input-dark rounded px-3 text-sm" placeholder="CIDR"></div>                            </div>                        </div>                        <div class="bg-sky-900/10 p-4 rounded border border-sky-900/30 mt-4">                            <label class="text-xs text-sky-300 block mb-2 uppercase font-bold">Tunnel Interface IP</label>                            <input type="text" id="pa_tunnel_ip" name="pa_tunnel_ip" value="169.255.1.2" class="w-full bg-gray-800 border border-gray-700 text-white rounded px-3 h-10 text-sm focus:ring-sky-500">                        </div>                        <!-- Hidden fields for syncing -->                        <input type="hidden" id="pa_remote_wan_ip" name="pa_remote_wan_ip">                        <input type="hidden" id="pa_remote_tunnel_ip" name="pa_remote_tunnel_ip">                        <input type="hidden" id="fg_remote_wan_ip" name="fg_remote_wan_ip">                        <input type="hidden" id="fg_remote_tunnel_ip_pa" name="fg_remote_tunnel_ip_pa">                    </div>                </div>            </div>            <!-- ACTION BUTTON -->            <div class="pt-4">                <button type="submit" id="generateButton" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg transform transition hover:scale-[1.01] flex justify-center items-center gap-3">                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>                    Generar Paquete Ansible (.zip)                </button>                <p id="message" class="text-center mt-4 text-sm font-mono"></p>            </div>        </form>    </div>    <script>        // --- LOGICA DE PUERTOS FORTIGATE ---        const fgPorts = Array.from({length: 10}, (_, i) => `port${i + 1}`);        const fgSelects = ['fg_wan_intf', 'fg_lan1_intf', 'fg_lan2_intf'];        const fgDefaultValues = { 'fg_wan_intf': 'port1', 'fg_lan1_intf': 'port2', 'fg_lan2_intf': 'port3' };        function initFortiPorts() {            fgSelects.forEach(selectId => {                const select = document.getElementById(selectId);                select.innerHTML = '';                fgPorts.forEach(port => {                    const option = document.createElement('option');                    option.value = port;                    option.text = port;                    select.appendChild(option);                });                select.value = fgDefaultValues[selectId];                select.addEventListener('change', validateFortiPorts);            });            validateFortiPorts();        }        function validateFortiPorts() {            const currentSelections = fgSelects.map(id => document.getElementById(id).value);            fgSelects.forEach((selectId, index) => {                const select = document.getElementById(selectId);                const options = select.options;                for (let i = 0; i < options.length; i++) {                    const optValue = options[i].value;                    const isSelectedElsewhere = currentSelections.some((val, idx) => val === optValue && idx !== index);                    if (isSelectedElsewhere) {                        options[i].disabled = true;                        options[i].text = `${optValue} (En uso)`;                    } else {                        options[i].disabled = false;                        options[i].text = optValue;                    }                }            });        }        // --- LOGICA DE PUERTOS PALO ALTO ---        const paPorts = Array.from({length: 10}, (_, i) => `ethernet1/${i + 1}`);        const paSelects = ['pa_wan_intf', 'pa_lan1_intf', 'pa_lan2_intf'];        const paDefaultValues = { 'pa_wan_intf': 'ethernet1/1', 'pa_lan1_intf': 'ethernet1/2', 'pa_lan2_intf': 'ethernet1/3' };        function initPaloPorts() {            paSelects.forEach(selectId => {                const select = document.getElementById(selectId);                select.innerHTML = '';                paPorts.forEach(port => {                    const option = document.createElement('option');                    option.value = port;                    option.text = port;                    select.appendChild(option);                });                select.value = paDefaultValues[selectId];                select.addEventListener('change', validatePaloPorts);            });            validatePaloPorts();        }        function validatePaloPorts() {            const currentSelections = paSelects.map(id => document.getElementById(id).value);            paSelects.forEach((selectId, index) => {                const select = document.getElementById(selectId);                const options = select.options;                for (let i = 0; i < options.length; i++) {                    const optValue = options[i].value;                    const isSelectedElsewhere = currentSelections.some((val, idx) => val === optValue && idx !== index);                    if (isSelectedElsewhere) {                        options[i].disabled = true;                        options[i].text = `${optValue} (En uso)`;                    } else {                        options[i].disabled = false;                        options[i].text = optValue;                    }                }            });        }        // --- SINCRONIZACIÓN DE IPs ---        function syncRemoteIPs() {            const fgWan = document.getElementsByName('fg_wan_ip')[0].value;            const paWan = document.getElementsByName('pa_wan_ip')[0].value;            const fgTunnel = document.getElementById('fg_tunnel_ip').value;            const paTunnel = document.getElementById('pa_tunnel_ip').value;            document.getElementById('pa_remote_wan_ip').value = paWan;            document.getElementById('pa_remote_tunnel_ip').value = paTunnel;            document.getElementById('fg_remote_wan_ip').value = fgWan;            document.getElementById('fg_remote_tunnel_ip_pa').value = fgTunnel;        }        // --- SUBMIT FORMULARIO (FETCH REAL AL BACKEND) ---        document.getElementById('vpnForm').addEventListener('submit', async function(event) {            event.preventDefault();            syncRemoteIPs();            const form = event.target;            const data = {};            for (let i = 0; i < form.elements.length; i++) {                const element = form.elements[i];                if (element.name && !element.disabled) {                    data[element.name] = element.value;                }            }            const messageElement = document.getElementById('message');            const btn = document.getElementById('generateButton');                        messageElement.textContent = 'Generando configuración en servidor...';            messageElement.className = 'text-center mt-4 text-sm font-mono text-yellow-400 animate-pulse';            btn.disabled = true;            btn.classList.add('opacity-50', 'cursor-not-allowed');            try {                // LLAMADA REAL AL ENDPOINT DE FLASK                const response = await fetch('/generate', {                    method: 'POST',                    headers: { 'Content-Type': 'application/json' },                    body: JSON.stringify(data)                });                if (response.ok) {                    const blob = await response.blob();                    const url = window.URL.createObjectURL(blob);                    const a = document.createElement('a');                    a.style.display = 'none';                    a.href = url;                    a.download = 'vpn_ansible_config.zip';                    document.body.appendChild(a);                    a.click();                    window.URL.revokeObjectURL(url);                    messageElement.textContent = '¡Descarga Exitosa!';                    messageElement.className = 'text-center mt-4 text-sm font-mono text-green-400';                } else {                    const errorText = await response.text();                    messageElement.textContent = `Error del servidor: ${errorText}`;                    messageElement.className = 'text-center mt-4 text-sm font-mono text-red-500';                }            } catch (error) {                console.error(error);                messageElement.textContent = 'Error de conexión con el servidor.';                messageElement.className = 'text-center mt-4 text-sm font-mono text-red-500';            } finally {                btn.disabled = false;                btn.classList.remove('opacity-50', 'cursor-not-allowed');            }        });        document.addEventListener('DOMContentLoaded', () => {            initFortiPorts();            initPaloPorts();            document.getElementsByName('fg_wan_ip')[0].addEventListener('input', syncRemoteIPs);            document.getElementsByName('pa_wan_ip')[0].addEventListener('input', syncRemoteIPs);            document.getElementById('fg_tunnel_ip').addEventListener('input', syncRemoteIPs);            document.getElementById('pa_tunnel_ip').addEventListener('input', syncRemoteIPs);        });    </script></body></html>"""# --- RUTAS DE FLASK ---@app.route('/')def index():    return render_template_string(HTML_TEMPLATE)@app.route('/generate', methods=['POST'])def generate():    try:        data = request.json                # Validaciones de seguridad básicas        if "'" in data['psk'] or '"' in data['psk']:            return "Error: La PSK contiene comillas inválidas", 400        pa_crypto_config = get_pa_crypto_config(data['crypto_profile'])        # Generación de archivos en memoria        files_to_zip = {            "vpn_ansible_config/inventory/hosts.yml": generate_hosts_yml(data),            "vpn_ansible_config/group_vars/all.yml": generate_group_vars_all_yml(data, pa_crypto_config),            "vpn_ansible_config/site.yml": generate_site_yml(data),            "vpn_ansible_config/ansible.cfg": """[defaults]inventory=./inventory/hosts.ymlhost_key_checking=Falsetimeout=30"""        }        # Creación del ZIP        zip_buffer = io.BytesIO()        with zipfile.ZipFile(zip_buffer, 'a', zipfile.ZIP_DEFLATED, False) as zip_file:            for filename, content in files_to_zip.items():                zip_file.writestr(filename, content.encode('utf-8'))                zip_buffer.seek(0)                return send_file(            zip_buffer,            mimetype='application/zip',            as_attachment=True,            download_name='vpn_ansible_config.zip'        )    except Exception as e:        return str(e), 500if __name__ == '__main__':    # Ejecuta el servidor en todas las interfaces, puerto 5000    app.run(host='0.0.0.0', port=5000, debug=True)