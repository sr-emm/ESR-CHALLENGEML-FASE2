# ===================================================================
# Archivo: fortigate_vpn_wildcard.conf
# Descripción: Configuración VPN IPSec Site-to-Site (Route-Based)
# Target: FortiGate (Site A) -> Palo Alto (Site B)
# Estrategia: IKEv2 + Wildcard Selectors (0.0.0.0/0)
# ===================================================================

# -------------------------------------------------------------------
# 1. Configuración de Phase 1 (IKE Gateway)
# -------------------------------------------------------------------
config vpn ipsec phase1-interface
    edit "S2S-FG-PA"
        set interface "port1"
        set peertype any
        set remote-gw 200.200.200.1
        set psksecret "S1-S2_vpn!Q9u5#2025"
        set ike-version 2
        
        # Propuesta Criptográfica (Coincide con PA)
        set proposal aes256-sha256 aes192-sha256
        set dhgrp 14
        set keylife 43200
        
        # Compatibilidad NAT-T y DPD
        set nattraversal enable
        set dpd on-demand
        set dpd-retryinterval 20
        set dpd-max-fail 3
    next
end

# -------------------------------------------------------------------
# 2. Configuración de Phase 2 (IPSec Tunnel)
# -------------------------------------------------------------------
config vpn ipsec phase2-interface
    edit "S2S-FG-PA-P2"
        set phase1name "S2S-FG-PA"
        set proposal aes256-sha256 aes192-sha256
        set pfs enable
        set dhgrp 14
        
        # CRÍTICO: Lifetime ajustado a 3600s para igualar a Palo Alto
        set keylifeseconds 3600
        
        # CRÍTICO: Selectores Wildcard para modo Route-Based puro
        set src-subnet 0.0.0.0 0.0.0.0
        set dst-subnet 0.0.0.0 0.0.0.0
        
        set auto-negotiate enable
        set replay enable
    next
end

# -------------------------------------------------------------------
# 3. Interfaz de Túnel (VTI)
# -------------------------------------------------------------------
config system interface
    edit "S2S-FG-PA"
        set vdom "root"
        set ip 169.255.1.1 255.255.255.252
        set allowaccess ping
        set type tunnel
        set interface "port1"
        set description "Tunel hacia Palo Alto (Site B)"
    next
end

# -------------------------------------------------------------------
# 4. Enrutamiento (Static Routes)
# -------------------------------------------------------------------
config router static
    edit 10
        set dst 10.200.201.0 255.255.255.0
        set gateway 169.255.1.2
        set device "S2S-FG-PA"
        set comment "Ruta a Site B - LAN 1"
    next
    edit 11
        set dst 10.200.202.0 255.255.255.0
        set gateway 169.255.1.2
        set device "S2S-FG-PA"
        set comment "Ruta a Site B - LAN 2"
    next
end

# -------------------------------------------------------------------
# 5. Políticas de Firewall (No NAT + MSS Clamping)
# -------------------------------------------------------------------
config firewall policy
    # LAN -> VPN
    edit 100
        set name "LAN-to-S2S-FG-PA"
        set srcintf "port2" "port3"
        set dstintf "S2S-FG-PA"
        set srcaddr "all"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
        
        # NO NAT (Routed VPN)
        set nat disable
        
        # Optimización MTU/MSS para IPSec overhead
        set tcp-mss-sender 1360
        set tcp-mss-receiver 1360
        
        set logtraffic all
    next
    
    # VPN -> LAN
    edit 101
        set name "S2S-FG-PA-to-LAN"
        set srcintf "S2S-FG-PA"
        set dstintf "port2" "port3"
        set srcaddr "all"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
        set nat disable
        set tcp-mss-sender 1360
        set tcp-mss-receiver 1360
        set logtraffic all
    next
end