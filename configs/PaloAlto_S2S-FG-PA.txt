# ==========================================
# Palo Alto (Site 2) - Final Wildcard Config
# ==========================================

# 1) Tunnel Interface (MTU Optimized)
set network interface tunnel units tunnel.1 ip 169.255.1.2/30
set network interface tunnel units tunnel.1 comment "S2S-FG-PA"
set network interface tunnel units tunnel.1 mtu 1436
set network interface tunnel units tunnel.1 adjust-tcp-mss yes

# 2) Zone Creation (VPN Zone)
# (Assumes 'trust' and 'untrust' exist. We create 'vpn' here)
set zone vpn network layer3 tunnel.1

# 3) Virtual Router (Add tunnel.1)
set network virtual-router VR1 interface [ ethernet1/1 ethernet1/2 ethernet1/3 tunnel.1 ]

# 4) IKE Profile (Phase 1)
set network ike crypto-profiles ike S2S-FG-PA-IKE encryption aes-256-cbc aes-192-cbc
set network ike crypto-profiles ike S2S-FG-PA-IKE hash sha256
set network ike crypto-profiles ike S2S-FG-PA-IKE dh-group group14
set network ike crypto-profiles ike S2S-FG-PA-IKE lifetime-seconds 43200

# 5) IPsec Profile (Phase 2)
# Matches FortiGate Proposals & 3600s Lifetime
set network tunnel ipsec crypto-profiles ipsec S2S-FG-PA-IPSEC esp aes-256-cbc aes-192-cbc
set network tunnel ipsec crypto-profiles ipsec S2S-FG-PA-IPSEC authentication sha256
set network tunnel ipsec crypto-profiles ipsec S2S-FG-PA-IPSEC dh-group group14
set network tunnel ipsec crypto-profiles ipsec S2S-FG-PA-IPSEC lifetime-seconds 3600

# 6) IKE Gateway
set network ike gateway S2S-FG-PA-GW authentication pre-shared-key key "S1-S2_vpn!Q9u5#2025"
set network ike gateway S2S-FG-PA-GW protocol-version ikev2
set network ike gateway S2S-FG-PA-GW local-address interface ethernet1/1
set network ike gateway S2S-FG-PA-GW local-address ip 200.200.200.1
set network ike gateway S2S-FG-PA-GW peer-address ip 100.100.100.1
set network ike gateway S2S-FG-PA-GW ike-crypto-profile S2S-FG-PA-IKE
set network ike gateway S2S-FG-PA-GW nat-traversal yes
set network ike gateway S2S-FG-PA-GW dead-peer-detection enable yes

# 7) IPsec Tunnel (Wildcard Proxy ID)
set network tunnel ipsec S2S-FG-PA auto-key ike-gateway S2S-FG-PA-GW
set network tunnel ipsec S2S-FG-PA auto-key ipsec-crypto-profile S2S-FG-PA-IPSEC
set network tunnel ipsec S2S-FG-PA tunnel-interface tunnel.1
set network tunnel ipsec S2S-FG-PA disabled no

# MATCHING THE FORTIGATE WILDCARD (0.0.0.0/0)
set network tunnel ipsec S2S-FG-PA auto-key proxy-id Wildcard_S2S local 0.0.0.0/0 remote 0.0.0.0/0 protocol any

# 8) Routing (Static Routes to Site 1)
set network virtual-router VR1 routing-table ip static-route To-Site1-LAN1 dst 10.100.101.0/24 interface tunnel.1 nexthop ip-address 169.255.1.1
set network virtual-router VR1 routing-table ip static-route To-Site1-LAN2 dst 10.100.102.0/24 interface tunnel.1 nexthop ip-address 169.255.1.1

# 9) Security Policies (No NAT)
# Allow Traffic LAN -> VPN
set rulebase security rules trust-to-S2S-FG-PA from trust to vpn source [ 10.200.201.0/24 10.200.202.0/24 ] destination [ 10.100.101.0/24 10.100.102.0/24 ] application any service application-default action allow log-end yes
# Allow Traffic VPN -> LAN
set rulebase security rules S2S-FG-PA-to-trust from vpn to trust source [ 10.100.101.0/24 10.100.102.0/24 ] destination [ 10.200.201.0/24 10.200.202.0/24 ] application any service application-default action allow log-end yes
# Allow IKE on WAN
set rulebase security rules S2S-FG-PA-IPSEC-IN from untrust to untrust source 100.100.100.1 destination 200.200.200.1 application [ ike ipsec-esp ] service application-default action allow log-end yes